---
title: "MD7115: R for Graph, Network and Trees"
subtitle: "Applications in Biomedical Research"
author: '<br><br>Xiaotao Shen <br> Assistant Professor / <a href="http://shen-lab.org/">Shen lab</a> <br> <a href="http://shen-lab.org"> <i class="fa fa-home fa-fw"></i>&nbsp; shen-lab.org</a><br> <a href="mailto:xiaotao.shen@ntu.edu.sg"><i class="fa fa-paper-plane fa-fw"></i>&nbsp; xiaotao.shen@ntu.edu.sg</a><br>'
institute: "Lee Kong Chian School of Medicine, NTU Singapore"
date: '`r Sys.Date()`'
output: 
  xaringan::moon_reader:
    css: [xaringan-themer.css, my-theme.css]
    # includes:
    #   after_body: insert-logo.html
    nature:
      ratio: '16:9'
      countdown: false
      titleSlideClass: [center, middle]
      # highlightStyle: dark
      # highlightLines: true
      countIncrementalSlides: false
    seal: true
    yolo: false
    # font_adjustment: -2
---


layout: true
background-image: url(images/lkc_logo.png)
background-position: 100% 0%
background-size: 20%
  
<div class="my-footer"><span>Xiaotao Shen/www.shen-lab.org</span></div> 

---


```{r setup, echo = FALSE, message = FALSE, warning = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = FALSE, 
                      message = FALSE, cache = TRUE, dpi = 72)
library(tidyverse)
options(warn = -1)
```

```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
# mono_dark(base_color = "green",
#           padding = 
#           background_color = "black",
#           text_color = "green",
#           link_color = "#eba134",
#           text_slide_number_color = "green",
#           inverse_background_color = "black",
#           inverse_text_color = "green",
#           inverse_header_color = "green",
#           header_font_family = google_font(family = "Lato"),
#           text_font_google = google_font(family = "Lato"),
#           code_font_google   = google_font("Droid Mono"),
#           header_h1_font_size = "30px", 
#           header_h2_font_size = "25px", 
#           header_h3_font_size = "20px",
#           text_font_size = "20px",
#           code_font_size = "1em",
#           table_border_color = "green",
#           table_row_border_color = "green", 
#           footnote_color = "green", 
#           footnote_font_size = "5px",
#           text_bold_color = "green",
#           header_color = "green"
#           )
mono_dark(base_color = "#cbf7ed", black_color = "white")
```

# About the class

-   **Instructor**: Xiaotao Shen (https://www.shen-lab.org/)

-   **Email**: xiaotao.shen@ntu.edu.stg

-   **WhatsApp**: +1 5712679283

-   **Github Repo**: https://github.com/jaspershen-lab/MD7115-NTU

-   **Reference**:

1.  [R for Data Science](https://r4ds.had.co.nz/)
2.  [R Graphics Cookbook](https://r-graphics.org/)
3.  [Network Analysis with R](https://www.amazon.com/Network-Analysis-R-Use/dp/3319238822)

---

# Introduction

In this course, we will learn how to use R to analyze and visualize data in the form of graphs, networks and trees. We will cover the following topics.

1. What is a graph, network and tree?

2. Their applications in biomedical research

3. How to use R to analyze and visualize them

4. Examples

---

# Preparation

We need to install some R packages before the class.

Some packages are in Bionconductor, so we need to install `BiocManager` first.

```{r, echo=TRUE, eval = TRUE}
if (!requireNamespace("BiocManager", quietly = TRUE)){
install.packages("BiocManager")
}
```

`tidyverse` is a collection of R packages designed for data science, and it includes `ggplot2`, which is a basic graph package for network and tree in R.

```{r, echo=TRUE, eval = TRUE}
if (!requireNamespace("tidyverse", quietly = TRUE)){
install.packages("tidyverse")
}
```

---

# Preparation

Some specific packages for graph and network.

```{r, echo=TRUE, eval = TRUE}
if (!requireNamespace("igraph", quietly = TRUE)){
install.packages("igraph")
}
if(!requireNamespace("ggraph", quietly = TRUE)){
install.packages("ggraph")
}
if(!requireNamespace("tidygraph", quietly = TRUE)){
install.packages("tidygraph")
}
if(!requireNamespace("ggnetwork", quietly = TRUE)){
install.packages("ggnetwork")
}
```

---

# Preparation

Some specific packages for tree analysis.

```{r, echo=TRUE, eval = TRUE}
if(!requireNamespace("ggtree", quietly = TRUE)){
BiocManager::install("ggtree")  
}
if(!requireNamespace("treeio", quietly = TRUE)){
BiocManager::install("treeio")  
}
if(!requireNamespace("ggtreeExtra", quietly = TRUE)){
BiocManager::install("ggtreeExtra")  
}
```

---

# What is a graph?

.pull-left[
A graph is a collection of nodes (vertices) and edges (links) that connect pairs of nodes.

A small undirected graph with numbered nodes.
]


.pull-right[
<img src="images/graph.png" alt="a graph" width="70%">
]



---

# Example 1

<div style="display: flex; justify-content: center; align-items: center;">
    <img src="images/ED_FIG7.jpg" alt="Description of the image" width="55%">
</div>

> [Shen, et al. Nature Biomedical Engineering, 2024](https://www.shen-lab.org/publication/Multi-omics%20microsampling%20for%20the%20profiling%20of%20lifestyle-associated%20changes%20in%20health.pdf)

---

# Example 1

What's the network?

.pull-left[
**Nodes**:

-   Wearable data: Step, HR, and CGM (continuous glucose monitoring) data

-   Omics data: Proteins, metabolites, and lipids

**Edges**:

-   Lagged correlations

-   Blue: negative correlations

-   Red: positive correlations
]

.pull-right[
<div style="display: flex; justify-content: center; align-items: center;">
    <img src="images/ED_FIG7.jpg" alt="Description of the image" width="100%">
</div>
]


---

# Read the data

```{r, echo=TRUE, eval = TRUE}
# node data
if (!require(readr)) {
  install.packages("readr")
}
node_data =
  readr::read_csv(
    "https://raw.githubusercontent.com/jaspershen-lab/MD7115-NTU/main/2_demo_data/example_node_data.csv"
  )
```

---

# Read the data

```{r, echo=TRUE, eval = TRUE}
#edge data
edge_data =
  readr::read_csv(
    "https://raw.githubusercontent.com/jaspershen-lab/MD7115-NTU/main/2_demo_data/example_edge_data.csv"
  )
```

---

# Node data

.pull-left[
```{r, echo=TRUE, eval = TRUE}
dim(node_data)
head(node_data)
```
]


.pull-right[

319 nodes

- node: The ID of the node, character

- class: The class of the node, character

- mol_name: The name of the molecule, character

- Other: all the other attributes of the edge
]

---

# Edge data

.pull-left[
```{r, echo=TRUE, eval = TRUE, width=40}
dim(edge_data)
```
```{r, echo=TRUE, eval = FALSE, width=40}
head(edge_data)
```
```{r, echo=FALSE, eval = TRUE, width=40}
options(width = 40)
print(head(edge_data))
# Reset to default width
options(width = 80)
```
]


.pull-right[

337 edges

- from: The ID of the source node, character

- to: The ID of the target node, character

- Other: all the other attributes of the edge
]

---

# Create a graph

```{r, echo=TRUE, eval = TRUE}
library(igraph)
library(tidyverse)
library(ggraph)
library(tidygraph)
graph_data =
  tidygraph::tbl_graph(nodes = node_data,
                       edges = edge_data,
                       directed = FALSE) %>%
  dplyr::mutate(Degree = centrality_degree(mode = 'all'))
```

`centrality_degree` is from the package `tidygraph` to calcualte the degree of the nodes.

```{r, echo=TRUE, eval = TRUE}
?centrality_degree
```

---

# Create a graph

```{r, echo=TRUE, eval = TRUE}
graph_data
```

---

# Visualize the graph

.pull-left[
```{r, echo=TRUE, eval = FALSE}
ggraph(graph_data, layout = 'kk') +
  geom_edge_link() +
  geom_node_point(
  )
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
ggraph(graph_data, layout = 'kk') +
  geom_edge_link() +
  geom_node_point(
  )
```
]

---

# Another layout

.pull-left[
```{r, echo=TRUE, eval = FALSE}
ggraph(graph_data, layout = 'fr') +
  geom_edge_link() +
  geom_node_point(
  )
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
ggraph(graph_data, layout = 'fr') +
  geom_edge_link() +
  geom_node_point(
  )
```
]

---

# Modification: more information in the network

.pull-left[
```{r, echo=TRUE, eval = FALSE}
plot =  
ggraph(graph_data, layout = 'kk') +
  geom_edge_link(aes(
    color = lagged_cor,
    width = -log(lagged_cor_p_adjust, 10)
  ),
  alpha = 0.5,
  show.legend = TRUE) +
  geom_node_point(
    aes(fill = class, size = Degree),
    shape = 21,
    alpha = 0.5,
    show.legend = TRUE
  )
plot
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
options(warn = -1)
plot =  
ggraph(graph_data, layout = 'kk') +
  geom_edge_link(aes(
    color = lagged_cor,
    width = -log(lagged_cor_p_adjust, 10)
  ),
  alpha = 0.5,
  show.legend = TRUE) +
  geom_node_point(
    aes(fill = class, size = Degree),
    shape = 21,
    alpha = 0.5,
    show.legend = TRUE
  )
plot
```
]


---

# Modification: more information in the network

.pull-left[
```{r, echo=TRUE, eval = FALSE}
plot =
  plot +
  shadowtext::geom_shadowtext(
    aes(
      x = x,
      y = y,
      label = ifelse(class2 == "wearable", mol_name, NA),
      color = class
    ),
    bg.color = "white",
    size = 5,
    show.legend = FALSE
  )
plot
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
options(warn = -1)
plot =
  plot +
  shadowtext::geom_shadowtext(
    aes(
      x = x,
      y = y,
      label = ifelse(class2 == "wearable", mol_name, NA),
      color = class
    ),
    bg.color = "white",
    size = 5,
    show.legend = FALSE
  )
plot
```
]


---

# Modification: more information in the network

Set colors for nodes

```{r, echo=TRUE, eval = TRUE}
class_color =
  c(
    "lipidomics" = ggsci::pal_aaas()(10)[1],
    "metabolomics" = ggsci::pal_aaas()(10)[3],
    "cytokine" = ggsci::pal_aaas()(10)[4],
    "total_protein" = ggsci::pal_aaas()(10)[5],
    "cortisol" = ggsci::pal_aaas()(10)[6],
    "metabolic_panel" = ggsci::pal_aaas()(10)[7],
    "proteomics" = ggsci::pal_aaas()(10)[8]
  )

wearable_color =
  c(
    "sleep" = ggsci::pal_d3()(n = 10)[2],
    "cgm"  = ggsci::pal_d3()(n = 10)[6],
    "hr" = ggsci::pal_d3()(n = 10)[7],
    "step"  = ggsci::pal_d3()(n = 10)[9],
    "food" = ggsci::pal_d3()(n = 10)[10]
  )
```

---

# Modification: more information in the network

.pull-left[
```{r, echo=TRUE, eval = FALSE}
plot = 
  plot +
  scale_size_continuous(range = c(3, 10)) +
  scale_fill_manual(values = c(class_color, wearable_color)) +
  scale_color_manual(values = c(class_color, wearable_color)) +
  scale_edge_width_continuous(range = c(0.3, 2)) +
  ggraph::scale_edge_color_gradientn(colours = c(alpha("#3B4992FF", 0.7), "white", alpha("#EE0000FF", 0.7))) +
  ggraph::theme_graph() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.position = "right",
    legend.background = element_rect(fill = "transparent", color = NA)
  )
plot
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
options(warn = -1)
plot =
  plot +
  scale_size_continuous(range = c(3, 10)) +
  scale_fill_manual(values = c(class_color, wearable_color)) +
  scale_color_manual(values = c(class_color, wearable_color)) +
  scale_edge_width_continuous(range = c(0.3, 2)) +
  ggraph::scale_edge_color_gradientn(colours = c(alpha("#3B4992FF", 0.7), "white", alpha("#EE0000FF", 0.7))) +
  ggraph::theme_graph() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.position = "right",
    legend.background = element_rect(fill = "transparent", color = NA)
  )
plot
```
]


---

# Change to circle layout

```{r, echo=TRUE, eval = TRUE}
g = graph_data
library(igraph)
library(ggraph)

V(g)$type = bipartite_mapping(g)$type

coords =
  create_layout(g, layout = "bipartite") %>%
  dplyr::select(node, class, mol_name, class2, x, y)

head(coords)
```

---

# Change to circle layout

.pull-left[
```{r, echo=TRUE, eval = TRUE}
coords$y[coords$class2 == "internal-omics"] = 1
coords$y[coords$class2 == "wearable"] = -0.5

coords$y[coords$class == "metabolomics"] = 1
coords$y[coords$class == "lipidomics"] = 0.5
coords$y[coords$class == "proteomics"] = 0
coords$y[coords$class == "cytokine"] = 0
coords$y[coords$class == "metabolic_panel"] = 0
coords$y[coords$class == "total_protein"] = 0

coords =
  coords %>%
  dplyr::select(x, y) %>%
  dplyr::mutate(
    theta = x / (max(x) + 1) * 2 * pi,
    r = y + 1,
    x = r * cos(theta),
    y = r * sin(theta)
  )
```
]

.pull-right[
```{r, echo=TRUE, eval = TRUE}
head(coords)
```
]


---

# Change to circle layout

.pull-left[
```{r, echo=TRUE, eval = TRUE}
my_graph =
  create_layout(
    graph = g,
    layout = "manual",
    x = coords$x,
    y = coords$y
  )
```
]

.pull-right[
```{r, echo=TRUE, eval = TRUE}
head(my_graph)
```
]

---

# Visualize the circle layout

.pull-left[
```{r, echo=TRUE, eval = TRUE}
plot =
  ggraph(my_graph, layout = 'bipartite') +
  geom_edge_diagonal(aes(
    color = lagged_cor,
    width = -log(lagged_cor_p_adjust, 10)
  ),
  alpha = 0.5,
  show.legend = TRUE) +
  geom_node_point(
    aes(fill = class, size = Degree),
    shape = 21,
    alpha = 0.5,
    show.legend = TRUE
  )
```
]

.pull-right[
```{r, echo=TRUE, eval = TRUE}
plot
```
]

---

# Visualize the circle layout

.pull-left[
```{r, echo=TRUE, eval = TRUE}
plot =
  plot +
  shadowtext::geom_shadowtext(
    aes(
      x = x,
      y = y,
      label = ifelse(class2 == "wearable", mol_name, NA),
      color = class
    ),
    bg.color = "white",
    size = 5,
    show.legend = FALSE
  ) +
  shadowtext::geom_shadowtext(
    aes(
      x = x,
      y = y,
      label = ifelse(class2 == "wearable", NA, mol_name),
      color = class,
      nudge_y = ifelse(class2 == "wearable", "inward", 'outward'),
      angle = -((-node_angle(x, y) + 90) %% 180) + 90
    ),
    bg.color = "white",
    size = 2,
    show.legend = FALSE,
    check_overlap = TRUE
  )
```
]

.pull-right[
```{r, echo=TRUE, eval = TRUE}
plot
```
]

---

# Visualize the circle layout

```{r, echo=TRUE, eval = TRUE}
plot =
  plot +
  scale_size_continuous(range = c(3, 10)) +
  scale_fill_manual(values = c(class_color, wearable_color)) +
  scale_color_manual(values = c(class_color, wearable_color)) +
  scale_edge_width_continuous(range = c(0.3, 2)) +
  ggraph::scale_edge_color_gradientn(colours = c(alpha("#3B4992FF", 0.7), "white", alpha("#EE0000FF", 0.7))) +
  ggraph::theme_graph() +
  theme(
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.background = element_rect(fill = "transparent", color = NA),
    legend.position = "bottom",
    legend.background = element_rect(fill = "transparent", color = NA)
  ) 
```

---

# Visualize the circle layout

.pull-left[
```{r, echo=TRUE, eval = FALSE}
plot
```
]

.pull-right[
```{r, echo=FALSE, eval = TRUE}
plot
```
]

---

# Save the plot

We need to install `extrafont` to save the plot.

```{r, echo=TRUE, eval = TRUE}
if (!require(extrafont)) {
  install.packages("extrafont")
}
```

```{r, echo=TRUE, eval = FALSE}
extrafont::loadfonts()
ggsave(plot, filename = "network.pdf", width = 9.5, height = 10)
```


# Example 2


---

# More references

1.  [Morden Statistics for Morden Biology](https://web.stanford.edu/class/bios221/book/10-chap.html#combining-phylogenetic-trees-into-a-data-analysis)

2.  [Network Analysis with R](https://www.amazon.com/Network-Analysis-R-Use/dp/3319238822)
